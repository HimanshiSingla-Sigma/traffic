<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Management Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .video-panel, .data-panel {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        .metric-box {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        #videoStream {
            width: 100%;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .chart-container {
            margin-top: 20px;
            height: 300px;
        }
    </style>
</head>
<body>
    <h1>ðŸš¦ Smart Traffic Management System</h1>

    <div class="container">
        <div class="video-panel">
            <h2>Live Feed & Analysis</h2>
            <img src="{{ url_for('video_feed') }}" id="videoStream" alt="Live Video Feed">
        </div>

        <div class="data-panel">
            <h2>Real-Time Metrics</h2>
            <div class="metrics">
                <div class="metric-box">
                    <div>Cars</div>
                    <div class="metric-value" id="carCount">0</div>
                </div>
                <div class="metric-box">
                    <div>Buses</div>
                    <div class="metric-value" id="busCount">0</div>
                </div>
                <div class="metric-box">
                    <div>Trucks</div>
                    <div class="metric-value" id="truckCount">0</div>
                </div>
                <div class="metric-box">
                    <div>Motorcycles</div>
                    <div class="metric-value" id="motorcycleCount">0</div>
                </div>
            </div>

            <div class="metric-box" style="grid-column: span 2;">
                <div>Total Vehicles</div>
                <div class="metric-value" id="totalCount">0</div>
            </div>
            <div class="metric-box" style="grid-column: span 2;">
                <div>Recommended Green Time</div>
                <div class="metric-value" id="greenTime">0s</div>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <h2>Traffic Density & Signal Timing Trend</h2>
        <canvas id="trafficChart"></canvas>
    </div>

    <script>
        // Initialize the chart
        const ctx = document.getElementById('trafficChart').getContext('2d');
        const trafficChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Time labels will be added by updateData()
                datasets: [
                    {
                        label: 'Traffic Density (Number of Vehicles)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        yAxisID: 'y',
                        tension: 0.1
                    },
                    {
                        label: 'Green Signal Time (Seconds)',
                        data: [],
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        yAxisID: 'y1',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        title: { display: true, text: 'Number of Vehicles' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        title: { display: true, text: 'Green Time (s)' },
                        grid: { drawOnChartArea: false }
                    }
                }
            }
        });

        // Function to fetch data from the Flask backend and update the dashboard
        function updateData() {
            fetch('/traffic_data')
                .then(response => response.json())
                .then(data => {
                    // Update the metric boxes
                    document.getElementById('carCount').textContent = data.counts.car || 0;
                    document.getElementById('busCount').textContent = data.counts.bus || 0;
                    document.getElementById('truckCount').textcontent = data.counts.truck || 0;
                    document.getElementById('motorcycleCount').textContent = data.counts.motorcycle || 0;
                    document.getElementById('totalCount').textContent = data.total;
                    document.getElementById('greenTime').textContent = data.green_time + 's';

                    // Update the chart
                    trafficChart.data.labels = data.time_labels;
                    trafficChart.data.datasets[0].data = data.density_history;
                    trafficChart.data.datasets[1].data = data.timing_history;
                    trafficChart.update();
                });
        }

        // Update the data every 2 seconds (adjust as needed)
        setInterval(updateData, 2000);
        // Initial update
        updateData();
    </script>
</body>
</html> -->






<!-- four lanes correct -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Traffic Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --red-light: #F44336;
            --yellow-light: #FFC107;
            --green-light: #4CAF50;
            --card-shadow: 0 10px 30px rgba(0,0,0,0.2);
            --card-radius: 15px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: var(--primary-gradient);
            color: #333;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--card-radius);
        }

        h1 {
            font-size: 2.2em;
            margin-bottom: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }

        @media (min-width: 1024px) {
            .dashboard {
                grid-template-columns: 1.5fr 1fr;
            }
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        @media (min-width: 768px) {
            .video-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .lane-video {
            position: relative;
            border: 3px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: #000;
            min-height: 200px;
            aspect-ratio: 16/9;
        }

        .lane-video.green {
            border-color: var(--green-light);
            box-shadow: 0 0 15px rgba(76, 175, 80, 0.5);
        }

        .lane-video.yellow {
            border-color: var(--yellow-light);
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);
        }

        .lane-video.red {
            border-color: var(--red-light);
            box-shadow: 0 0 15px rgba(244, 67, 54, 0.5);
        }

        .lane-header {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
            font-size: 0.9em;
        }

        .lane-stats {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 10;
            font-size: 0.85em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--primary-gradient);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            margin: 8px 0;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .vehicle-distribution {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        @media (min-width: 480px) {
            .vehicle-distribution {
                grid-template-columns: 1fr 1fr;
            }
        }

        .distribution-card {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .distribution-card h4 {
            margin-bottom: 8px;
            color: #495057;
        }

        .distribution-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 0.9em;
        }

        .charts-section {
            margin-bottom: 25px;
        }

        .chart-container {
            height: 300px;
            margin-top: 15px;
        }

        .control-panel {
            text-align: center;
            margin-bottom: 25px;
        }

        .control-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
        }

        button {
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            background: var(--primary-gradient);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            min-width: 140px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .system-info {
            text-align: center;
            color: white;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: var(--card-radius);
            font-size: 0.9em;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 5;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš¦ Smart Traffic Management System</h1>
            <p>Real-time traffic monitoring and adaptive signal control</p>
        </header>

        <div class="dashboard">
            <div class="card">
                <h2>Live Camera Feeds</h2>
                <div class="video-grid">
                    {% for lane_id in lanes %}
                    <div class="lane-video red" id="lane-{{ lane_id }}">
                        <div class="loading-overlay" id="loading-{{ lane_id }}">
                            Loading video...
                        </div>
                        <div class="lane-header">Lane {{ lane_id }} - <span class="light-status" id="light-{{ lane_id }}">RED</span></div>
                        <img src="{{ url_for('video_feed', lane_id=lane_id) }}" width="100%" alt="Lane {{ lane_id }} Video" 
                             onload="document.getElementById('loading-{{ lane_id }}').style.display = 'none'">
                        <div class="lane-stats">
                            Vehicles: <span id="count-{{ lane_id }}">0</span> | 
                            Time: <span id="time-{{ lane_id }}">0</span>s
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="card">
                <h2>Traffic Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Vehicles</div>
                        <div class="stat-number" id="total-vehicles">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Current Green Lane</div>
                        <div class="stat-number" id="current-green-lane">1</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">System Uptime</div>
                        <div class="stat-number" id="system-uptime">00:00:00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Connections</div>
                        <div class="stat-number" id="active-connections">4</div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <h3>Vehicle Distribution</h3>
                    <div class="vehicle-distribution">
                        {% for lane_id in lanes %}
                        <div class="distribution-card">
                            <h4>Lane {{ lane_id }}</h4>
                            <div class="distribution-item">
                                <span>Cars:</span>
                                <span id="cars-{{ lane_id }}">0</span>
                            </div>
                            <div class="distribution-item">
                                <span>Buses:</span>
                                <span id="buses-{{ lane_id }}">0</span>
                            </div>
                            <div class="distribution-item">
                                <span>Trucks:</span>
                                <span id="trucks-{{ lane_id }}">0</span>
                            </div>
                            <div class="distribution-item">
                                <span>Motorcycles:</span>
                                <span id="motorcycles-{{ lane_id }}">0</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <div class="card charts-section">
            <h2>Traffic Density Trends</h2>
            <div class="chart-container">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>

        <div class="card control-panel">
            <h2>System Controls</h2>
            <div class="control-buttons">
                <button onclick="manualSwitch()">Manual Switch</button>
                <button onclick="emergencyMode()">Emergency Mode</button>
                <button onclick="resetSystem()">Reset System</button>
                <button onclick="exportData()">Export Data</button>
            </div>
        </div>

        <div class="system-info">
            <p>System Time: <span id="system-time">00:00:00</span> | 
               Last Update: <span id="last-update">00:00:00</span> | 
               Version: 1.0.0</p>
        </div>
    </div>

    <script>
        let trafficChart;
        let startTime = Date.now();
        let lastUpdateTime = Date.now();

        function updateUptime() {
            const now = Date.now();
            const uptime = new Date(now - startTime);
            document.getElementById('system-uptime').textContent = 
                uptime.toISOString().substr(11, 8);
        }

        function updateTrafficData() {
            fetch('/traffic_data')
                .then(response => response.json())
                .then(data => {
                    lastUpdateTime = Date.now();
                    document.getElementById('system-time').textContent = data.system_time;
                    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
                    document.getElementById('current-green-lane').textContent = data.current_green_lane;

                    let totalVehicles = 0;
                    const laneData = [];

                    for (let lane_id = 1; lane_id <= 4; lane_id++) {
                        const lane = data.lanes[lane_id];
                        totalVehicles += lane.total;
                        
                        // Update lane statistics
                        document.getElementById(`count-${lane_id}`).textContent = lane.total;
                        document.getElementById(`time-${lane_id}`).textContent = lane.green_time;
                        document.getElementById(`light-${lane_id}`).textContent = lane.light;
                        
                        // Update vehicle type counts
                        document.getElementById(`cars-${lane_id}`).textContent = lane.counts.car || 0;
                        document.getElementById(`buses-${lane_id}`).textContent = lane.counts.bus || 0;
                        document.getElementById(`trucks-${lane_id}`).textContent = lane.counts.truck || 0;
                        document.getElementById(`motorcycles-${lane_id}`).textContent = lane.counts.motorcycle || 0;

                        // Update lane border color based on light status
                        const laneElement = document.getElementById(`lane-${lane_id}`);
                        laneElement.className = 'lane-video ' + lane.light.toLowerCase();

                        laneData.push({
                            lane: lane_id,
                            density: lane.density_history,
                            timing: lane.timing_history,
                            labels: lane.time_labels
                        });
                    }

                    document.getElementById('total-vehicles').textContent = totalVehicles;
                    updateTrafficChart(laneData);
                })
                .catch(error => console.error('Error fetching traffic data:', error));
        }

        function updateTrafficChart(laneData) {
            const ctx = document.getElementById('trafficChart').getContext('2d');
            
            if (trafficChart) {
                trafficChart.destroy();
            }

            // Check if we have data to display
            if (!laneData.length || !laneData[0].density.length) {
                ctx.font = "16px Arial";
                ctx.fillStyle = "#666";
                ctx.textAlign = "center";
                ctx.fillText("No data available yet. Please wait...", 
                            ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            const datasets = laneData.map((data, index) => ({
                label: `Lane ${data.lane}`,
                data: data.density,
                borderColor: `hsl(${index * 90}, 70%, 50%)`,
                backgroundColor: `hsla(${index * 90}, 70%, 50%, 0.1)`,
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }));

            trafficChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: laneData[0]?.labels || [],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Vehicle Count'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: 'Traffic Density Over Time'
                        }
                    }
                }
            });
        }

        function manualSwitch() {
            if (confirm('Are you sure you want to manually switch traffic lights?')) {
                fetch('/manual_switch', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to execute manual switch');
                    });
            }
        }

        function emergencyMode() {
            if (confirm('Activate emergency mode? All lights will turn green for emergency vehicles.')) {
                fetch('/emergency_mode', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to activate emergency mode');
                    });
            }
        }

        function resetSystem() {
            if (confirm('Reset the entire system?')) {
                fetch('/reset_system', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        location.reload();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to reset system');
                    });
            }
        }

        function exportData() {
            alert('Data export feature coming soon!');
        }

        // Initialize and update data
        setInterval(updateUptime, 1000);
        setInterval(updateTrafficData, 2000); // Update every 2 seconds
        updateTrafficData(); // Initial update

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                updateTrafficData();
            }
        });

        // Handle video loading errors
        document.querySelectorAll('img').forEach(img => {
            img.onerror = function() {
                this.parentNode.querySelector('.loading-overlay').textContent = 'Video feed unavailable';
            };
        });
    </script>
</body>
</html>